#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

locale="en"

main() {
  while read version; do
    install_hanami_gems $version
    generate_docs $version
  done < versions
}

install_hanami_gems() {
  local version=$1
  local target="gems"

  echo "Installing Hanami $version"

  if [ -d $target ]; then
    rm -rf $target
  fi

  gem install --prerelease --force --install-dir=$target hanami:$version hanami-model:$version
}

generate_docs() {
  local version=$1
  local sources="gems/gems/hanami*/lib/**/*"
  local target="docs/$version"
  local title="Hanami API docs | $version"

  if [ -d $target ]; then
    rm -rf $target
  fi

  # yardoc
  #   --no-cache \ # Don't use cache
  #   --no-save  \ # Don't write cache
  #   # --protected \ # Include Ruby protected methods
  #   # --private \ # Include Ruby private methods
  #   # --no-private \ # Exclude methods with @api private
  #   # --title="$title" \ # HTML page title
  #   vendor/gems/hanami*/lib/**/*
  bundle exec yardoc --no-cache --no-save --protected --private --no-api private --markup markdown --readme=README_DOCS.md --locale=$locale --title="$title" --template-path . --template template --output-dir $target $sources
}

main
